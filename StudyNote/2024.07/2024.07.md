
## Transform.InverseTransformDirection()

 world좌표계의 direction 값을 local좌표계를 기준으로 변환한다.

### 캐릭터 local좌표 기준으로 이동 애니메이션 적용
Topdown 뷰의 게임에서
이동은 Y평면을 기준으로 이동하게끔 설정했다. (x축과 z축을 사용)

이때 캐릭터의 이동animation을 8방향으로 준비해놓았는데,
캐릭터가 바라보는 방향을 기준으로 애니메이션을 설정하고 싶었다.

ex) 마우스 커서가 캐릭터의 우측에 있는 경우<br>
캐릭터가 바라보는 방향은 (1,0,0) 방향<br>
W를 누르면, 캐릭터는 (0,0,1) 방향으로 이동<br>
애니메이션은 좌측이동 (-1,0,0) 애니메이션 재생

-> 커서방향을 바라보도록 캐릭터를 회전시키는 부분은 구현했고<br>
입력장치로부터 읽어들인 Vector2 이동 값의 방향벡터를 현재 캐릭터의 local좌표계로 변환시켰다.

```c#

void MoveAction_performed(InputAction.CallbackContext obj) {
  var moveValue = obj.ReadValue<Vector2>();
  m_Movement.Set(moveValue.x, 0f, moveValue.y);
}

void FixedUpdate() {
  //...
  // 스크린 중앙으로부터 커서의 방향
  Vector3 screenPosCenter = new Vector3(Screen.width * 0.5f, 0.0f, Screen.height * 0.5f);
  Vector3 directionToCursor = (m_CursorPos - screenPosCenter).normalized;

  // 커서 방향으로 회전 값 생성하여 m_Rotation 저장
  Vector3 desiredForward = Vector3.RotateTowards(transform.forward, directionToCursor, turnSpeed * Time.deltaTime, 0f);
  m_Rotation = Quaternion.LookRotation(desiredForward);

  Vector3 RotatedMovement = transform.InverseTransformDirection(m_Movement);
        
  m_Animator.SetFloat("xDir", RotatedMovement.x);
  m_Animator.SetFloat("yDir", RotatedMovement.z);

  //...
}

void OnAnimatorMove() {
  //...
  m_Rigidbody.MoveRotation(m_Rotation);

}
        

```

### ✍️) 부드러운 애니메이션 전환
키보드 D 입력 -> 키보드 W 입력<br>다음과 같이 WASD 키입력을 받으면,<br>
 (1,0) -> (0,1) 이런식으로 discrete 하게 값이 들어오는데<br>
저 값을 그대로 Animator 파라미터에 적용시키니 애니메이션이 부드럽게 전환되지 않는다.

-> 키보드로 입력받은 Vector2 값 SmoothDamp 함수를 이용하여 좀 더 부드럽게 전환되도록 했다. 

```c#
    private void MoveAction_performed(InputAction.CallbackContext obj)
    {
        var moveValue = obj.ReadValue<Vector2>();
        m_Movement.Set(moveValue.x, 0f, moveValue.y);
    }

  void FixedUpdate()
  {
    ...
    m_CurrentMovement = Vector3.SmoothDamp(m_CurrentMovement, m_Movement, ref velocity);
    ...
  }


```

issue) 좌측이동 후 우측이동 시, 애니메이터 파라미터 값을 살펴보면,<br> xDir 값이 (-1 -> 0 -> 1 )순서로 변경되면서, 중간의 idle 모션을 거쳐가는데. 이게 문제인 것 같다.


### ISSUE) 특정 애니메이션에서 속도 감소 
sample animation으로 무료 에셋을 가져다 샘플로 개발중인데,<br>
적용한 이동 애니메이션 중 특정 애니메이션이 재생될 때<br> 캐릭터의 이동속도가 감소했다.

확인해보니<br>
Rigidbody.MovePosition()을 이용하여 캐릭터를 움직이는 부분에서,
Animator.deltaPosition.magnitude 값이 계산에 사용되는데<br> 특정 애니메이션에서 해당 값이 매우 작게 찍힌다.<br>

```c#
  m_Rigidbody.MovePosition(m_Rigidbody.position + m_CurrentMovement * m_Animator.deltaPosition.magnitude);

```

-> Animator.deltaPosition 은 마지막으로 evaluated 된 프레임의 아바타 delta position을 반환한다.<br>
애니메이션에 의해 이동한 이동량을 반환, 루트모션과 관련이 있는 값이다.<br>

우선 deltaPosition 값을 사용하지 않고, 상수로 대체했더니, 애니메이션 변화에 상관없이 일정한 이동속도를 확인할 수 있었다.


왜 발생하는 문제인가?<br>
blend tree로 8방향에대한 애니메이션을 모두 설정했고,
파라미터 xDir, yDir에 의해 애니메이션이 재생된다.


테스트를 해보았다.<br>
WASD에서 우측이동(D) 을 하는 상태로<br>
마우스 커서를 움직이며 애니메이션 전환을 체크했다.<br>
1. 캐릭터의 진행방향과 동일 - @Forward<br>
 (@Forward -> @ForwardRight -> @Right)
2. 캐릭터의 진행방향과 수직 - @Right<br>
 (@Right -> @BackwardRight -> @Backward) !!여기가 문제!!
3. 캐릭터의 진행방향과 반대 - @Backward


@BackwardRight 모션의 deltaPosition이 캐릭터의 이동방향과 일치하지 않음. 


